/*
 * cool642tb_R.overlay (Zephyr標準 pixart,pmw3610 用)
 * - motion-gpios / zephyr,axis-x/y を追加（必須）
 * - duplex を HALF DUPLEX に（SDIO 1本想定）
 * - smart-mode を有効化
 * - automouse-layer は使わず、zip_temp_layer で AML 相当を実現
 */

#include "cool642tb.dtsi"

/* Input Processor を使う */
#include <input/processors.dtsi>
#include <dt-bindings/zmk/input_transform.h>

/* PMW3610 の axis コード */
#include <zephyr/dt-bindings/input/input-event-codes.h>

/* SPI HALF DUPLEX マクロ */
#include <dt-bindings/spi/spi.h>

&default_transform {
    col-offset = <6>;
};

&kscan0 {
    col-gpios
        = <&xiao_d 10 GPIO_ACTIVE_HIGH>
        , <&xiao_d 9 GPIO_ACTIVE_HIGH>
        , <&xiao_d 8 GPIO_ACTIVE_HIGH>
        , <&xiao_d 7 GPIO_ACTIVE_HIGH>
        , <&gpio0 10 GPIO_ACTIVE_HIGH>
        ;
};

/ {
    trackball_listener: trackball_listener {
        compatible = "zmk,input-listener";
        device = <&trackball>;

        /*
         * まず AML 相当：
         * ポインタ入力が来たら layer 4 を一時的に有効化し、
         * 500ms 入力が無ければ自動で解除
         *   (&zip_temp_layer <layer> <timeout_ms>)
         */
        input-processors =
            <&zip_temp_layer 4 500>,

            /*
             * 感度調整（カーソル移動）
             *   X: 12/10
             *   Y: 15/10
             */
            <&zip_x_scaler 16 10>,
            <&zip_y_scaler 15 10>;

        /*
         * スクロール（レイヤ1でのみ有効）
         *  - XY移動 → スクロールへ変換
         *  - 1/70 でスクロール量を調整（必要ならここだけ変更）
         */
        scroller {
            layers = <1>;
            input-processors =
                <&zip_xy_to_scroll_mapper>,
                <&zip_scroll_scaler 1 70>;
        };
    };
};

&pinctrl {
    spi0_default: spi0_default {
        group1 {
            psels = <NRF_PSEL(SPIM_SCK, 0, 5)>,
                    <NRF_PSEL(SPIM_MOSI, 0, 4)>,
                    <NRF_PSEL(SPIM_MISO, 0, 4)>;
        };
    };

    spi0_sleep: spi0_sleep {
        group1 {
            psels = <NRF_PSEL(SPIM_SCK, 0, 5)>,
                    <NRF_PSEL(SPIM_MOSI, 0, 4)>,
                    <NRF_PSEL(SPIM_MISO, 0, 4)>;
            low-power-enable;
        };
    };
};

&xiao_serial { status = "disabled"; };

&spi0 {
    status = "okay";
    compatible = "nordic,nrf-spim";
    pinctrl-0 = <&spi0_default>;
    pinctrl-1 = <&spi0_sleep>;
    pinctrl-names = "default", "sleep";
    cs-gpios = <&gpio0 9 GPIO_ACTIVE_LOW>;

    trackball: trackball@0 {
        status = "okay";
        compatible = "pixart,pmw3610";
        reg = <0>;
        spi-max-frequency = <2000000>;

        /*
         * SDIO(データ1本)構成なら HALF DUPLEX を明示
         * 0=FULL, 2048=HALF
         */
        duplex = <SPI_HALF_DUPLEX>;

        /* smart mode（表面条件の幅を広げる） */
        smart-mode;

        /*
         * Zephyr標準 binding で必須：
         * - motion pin（active low）
         * - axis code
         */
        motion-gpios = <&gpio0 2 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
        zephyr,axis-x = <INPUT_REL_X>;
        zephyr,axis-y = <INPUT_REL_Y>;

        /*
         * CPI（200刻み）。あなたの設定(400)に合わせる
         * ※必要なら 600/800... に上げて調整
         */
        res-cpi = <400>;

        /*
         * 方向が合わなければここで反転
         * 180度回転相当なら両方 invert が基本候補
         * （合わない方だけコメントアウトしてください）
         */
        invert-x;
        invert-y;

        /* resetピンがある場合だけ使う（無ければ不要） */
        // reset-gpios = <&gpio0 XX GPIO_ACTIVE_LOW>;
    };
};
