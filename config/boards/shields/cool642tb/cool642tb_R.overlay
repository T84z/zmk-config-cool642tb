/*
 * cool642tb_R.overlay
 * - Zephyr標準 pixart,pmw3610 を使用
 * - SDIO(1線)想定で HALF DUPLEX + smart-mode
 * - EC11 を devicetree で定義し、keymap-sensors に登録
 * - NFCTピンをGPIO化（CONFIG_NFCT_PINS_AS_GPIOS 置き換え）
 */

#include "cool642tb.dtsi"

/* Input Processor を使う */
#include <input/processors.dtsi>
#include <dt-bindings/zmk/input_transform.h>

/* PMW3610 axis code */
#include <zephyr/dt-bindings/input/input-event-codes.h>

/* SPI HALF DUPLEX */
#include <dt-bindings/spi/spi.h>

&default_transform {
    col-offset = <6>;
};

&kscan0 {
    col-gpios
        = <&xiao_d 10 GPIO_ACTIVE_HIGH>
        , <&xiao_d 9 GPIO_ACTIVE_HIGH>
        , <&xiao_d 8 GPIO_ACTIVE_HIGH>
        , <&xiao_d 7 GPIO_ACTIVE_HIGH>
        , <&gpio0 10 GPIO_ACTIVE_HIGH>
        ;
};

/* nRF52840のNFCピン(P0.09/P0.10)をGPIOとして使う */
&uicr {
    nfct-pins-as-gpios;
};

/
{
    /*
     * EC11 エンコーダ（回転）
     * ★ここは実配線に合わせて変更してください★
     */
    enc0: enc0 {
        compatible = "alps,ec11";
        status = "okay";

        /* 例：A=GPIO0.07, B=GPIO0.08（仮） */
        a-gpios = <&gpio0 7 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        b-gpios = <&gpio0 8 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;

        /* エンコーダ1回転あたりのパルス数（EC11は 20/24/30 など。手持ちに合わせる） */
        steps = <30>;
    };

    /*
     * ZMKに「このキーボードで使うセンサー一覧」を教えるノード
     * （EC11を実際に使うのに必要）
     */
    sensors: sensors {
        compatible = "zmk,keymap-sensors";
        sensors = <&enc0>;

        /* 1回転あたり何回“カチッ”で動作を発火させるか（一般に steps と同じ値にすると分かりやすい） */
        triggers-per-rotation = <30>;
    };

    /*
     * PMW3610 入力を受けてカーソル/スクロールに変換
     */
    trackball_listener: trackball_listener {
        compatible = "zmk,input-listener";
        device = <&trackball>;

        /*
         * Auto-mouse-layer相当：
         * 入力が来たら layer4 を一時的にON、500ms無入力でOFF
         */
        input-processors =
            <&zip_temp_layer 4 500>,

            /* 感度（カーソル移動） */
            <&zip_x_scaler 12 10>,
            <&zip_y_scaler 15 10>;

        /* レイヤ1でスクロール */
        scroller {
            layers = <1>;
            input-processors =
                <&zip_xy_to_scroll_mapper>,
                <&zip_scroll_scaler 1 70>;
        };
    };
};

&pinctrl {
    spi0_default: spi0_default {
        group1 {
            psels = <NRF_PSEL(SPIM_SCK, 0, 5)>,
                    <NRF_PSEL(SPIM_MOSI, 0, 4)>,
                    <NRF_PSEL(SPIM_MISO, 0, 4)>;
        };
    };

    spi0_sleep: spi0_sleep {
        group1 {
            psels = <NRF_PSEL(SPIM_SCK, 0, 5)>,
                    <NRF_PSEL(SPIM_MOSI, 0, 4)>,
                    <NRF_PSEL(SPIM_MISO, 0, 4)>;
            low-power-enable;
        };
    };
};

&xiao_serial { status = "disabled"; };

&spi0 {
    status = "okay";
    compatible = "nordic,nrf-spim";
    pinctrl-0 = <&spi0_default>;
    pinctrl-1 = <&spi0_sleep>;
    pinctrl-names = "default", "sleep";
    cs-gpios = <&gpio0 9 GPIO_ACTIVE_LOW>;

    trackball: trackball@0 {
        status = "okay";
        compatible = "pixart,pmw3610";
        reg = <0>;

        /* まずは2MHz。怪しければ 1MHz/500kHz に落として切り分け */
        spi-max-frequency = <2000000>;

        /* MOSI/MISO同一ピン(SDIO 1線)ならHALF DUPLEX推奨 */
        duplex = <SPI_HALF_DUPLEX>;

        /* 表面条件の許容を広げる（smart algorithm） */
        smart-mode;

        /* Zephyr標準bindingで必須 */
        motion-gpios = <&gpio0 2 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
        zephyr,axis-x = <INPUT_REL_X>;
        zephyr,axis-y = <INPUT_REL_Y>;

        /* CPI（200刻み想定）。あなたの 400 に合わせる */
        res-cpi = <400>;

        /* 方向が合わなければ反転（必要に応じて片方だけに） */
        invert-x;
        invert-y;
    };
};
